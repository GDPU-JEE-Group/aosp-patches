From 791ad4da906530e25d0ac84f810655ce3ba39cd7 Mon Sep 17 00:00:00 2001
From: chaixiang <973731820@qq.com>
Date: Fri, 7 Mar 2025 08:02:06 +0000
Subject: [PATCH 4/4] add state bar to display SIM carrier name

---
 .../base/core/res/res/values/config.xml       |  4 ++
 .../layout/status_bar_mobile_signal_group.xml | 11 ++++++
 .../statusbar/StatusBarMobileView.java        | 37 +++++++++++++++++++
 3 files changed, 52 insertions(+)

diff --git a/frameworks/base/core/res/res/values/config.xml b/frameworks/base/core/res/res/values/config.xml
index 2ad2a5cfd2..57fc098a76 100644
--- a/frameworks/base/core/res/res/values/config.xml
+++ b/frameworks/base/core/res/res/values/config.xml
@@ -55,6 +55,9 @@
         <item><xliff:g id="id">@string/status_bar_mute</xliff:g></item>
         <item><xliff:g id="id">@string/status_bar_volume</xliff:g></item>
         <item><xliff:g id="id">@string/status_bar_zen</xliff:g></item>
+        <item><xliff:g id="id">@string/status_bar_cx</xliff:g></item>
+        <item><xliff:g id="id">@string/status_bar_mobile</xliff:g></item>
+
         <item><xliff:g id="id">@string/status_bar_ethernet</xliff:g></item>
         <item><xliff:g id="id">@string/status_bar_wifi</xliff:g></item>
         <item><xliff:g id="id">@string/status_bar_hotspot</xliff:g></item>
@@ -81,6 +84,7 @@
     <string translatable="false" name="status_bar_zen">zen</string>
     <string translatable="false" name="status_bar_mute">mute</string>
     <string translatable="false" name="status_bar_volume">volume</string>
+    <string translatable="false" name="status_bar_cx">cx</string>
     <string translatable="false" name="status_bar_wifi">wifi</string>
     <string translatable="false" name="status_bar_cdma_eri">cdma_eri</string>
     <string translatable="false" name="status_bar_data_connection">data_connection</string>
diff --git a/frameworks/base/packages/SystemUI/res/layout/status_bar_mobile_signal_group.xml b/frameworks/base/packages/SystemUI/res/layout/status_bar_mobile_signal_group.xml
index 10d49b38ae..3b4bcb458c 100644
--- a/frameworks/base/packages/SystemUI/res/layout/status_bar_mobile_signal_group.xml
+++ b/frameworks/base/packages/SystemUI/res/layout/status_bar_mobile_signal_group.xml
@@ -31,6 +31,17 @@
         android:gravity="center_vertical"
         android:orientation="horizontal" >
 
+        <!-- 添加的TextView显示运营商名称 -->
+        <TextView
+            android:id="@+id/operator_name"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:textColor="@android:color/white"
+            android:textSize="12sp"
+            android:layout_gravity="center_vertical"
+            android:paddingEnd="4dp"
+            android:text="运营商名称" />
+
         <FrameLayout
             android:id="@+id/inout_container"
             android:layout_height="17dp"
diff --git a/frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/StatusBarMobileView.java b/frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/StatusBarMobileView.java
index 68dcdd9ff4..ea2b5e9d46 100644
--- a/frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/StatusBarMobileView.java
+++ b/frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/StatusBarMobileView.java
@@ -39,6 +39,13 @@ import com.android.systemui.DualToneHandler;
 import com.android.systemui.R;
 import com.android.systemui.plugins.DarkIconDispatcher.DarkReceiver;
 import com.android.systemui.statusbar.phone.StatusBarSignalPolicy.MobileIconState;
+import android.telephony.TelephonyManager;
+import android.widget.TextView;
+import android.util.Log;
+import android.telephony.SubscriptionInfo;
+import android.telephony.SubscriptionManager;
+import java.util.ArrayList;
+import java.util.List;
 
 public class StatusBarMobileView extends FrameLayout implements DarkReceiver,
         StatusIconDisplayable {
@@ -55,6 +62,8 @@ public class StatusBarMobileView extends FrameLayout implements DarkReceiver,
     private ImageView mIn;
     private ImageView mOut;
     private ImageView mMobile, mMobileType, mMobileRoaming;
+    private TextView mOperatorNameTextView;
+    private SubscriptionManager mSubscriptionManager;
     private View mMobileRoamingSpace;
     private int mVisibleState = -1;
     private DualToneHandler mDualToneHandler;
@@ -122,12 +131,40 @@ public class StatusBarMobileView extends FrameLayout implements DarkReceiver,
         mOut = findViewById(R.id.mobile_out);
         mInoutContainer = findViewById(R.id.inout_container);
 
+        setSimOperatorName();
+
         mMobileDrawable = new SignalDrawable(getContext());
         mMobile.setImageDrawable(mMobileDrawable);
 
         initDotView();
     }
 
+    private boolean setSimOperatorName(){
+        String SimOperatorName = ""; // 获取运营商名称
+        
+        mSubscriptionManager =(SubscriptionManager) getContext().getSystemService(Context.TELEPHONY_SUBSCRIPTION_SERVICE);
+
+        final List<SubscriptionInfo> subscriptionInfoList =
+                mSubscriptionManager.getActiveSubscriptionInfoList();
+        if (subscriptionInfoList != null) {
+            for (SubscriptionInfo info : subscriptionInfoList) {
+                if (info.getSimSlotIndex() == 0) {
+                    SimOperatorName = info.getCarrierName().toString();
+                }
+            }
+        }
+
+        // 找到 TextView 控件，并设置运营商名称
+        if (mOperatorNameTextView == null) {
+            mOperatorNameTextView = findViewById(R.id.operator_name); // 获取控件实例
+        }
+        Log.d("statusbar", "mOperatorNameTextView == null: " + (mOperatorNameTextView == null)+",SimOperatorName"+SimOperatorName);
+        if (mOperatorNameTextView != null) {
+            mOperatorNameTextView.setText(SimOperatorName); // 设置运营商名称
+        }
+        return true;
+    }
+
     private void initDotView() {
         mDotView = new StatusBarIconView(mContext, mSlot, null);
         mDotView.setVisibleState(STATE_DOT);
-- 
2.25.1

